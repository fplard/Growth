---
title: "run growth models"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{run-growth-models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(Growth)
```

<!-- WARNING - This vignette is generated by {fusen} from dev/flat_main.Rmd: do not edit by hand -->

<!--
You need to run the 'description' chunk in the '0-dev_history.Rmd' file before continuing your code there.
-->


#### Install `nimble`

If you never used the package `nimble`, you first need to install it following recommendations [here](https://r-nimble.org/download)




# Run a single model

The function `Gro_run()` allows to run one growth model. This function takes as arguments:

* `x` the index of the formula to use 
* `dat` including at least the numeric columns *Age*, *MeasurementValue* and *AnimalAnonID* 
* `all_mods` a vector of model names. The following models are supported : logistic, gompertz, tpgm, power, richards, vonbertalanffy.
* `random` list of the model names giving the parameters that should be included an individual random effect
* `run`: a list of Bayesian parameters including `nch` number of chains, `nthin` interval between iterations to keep, `nburnin` number of iterations to discard and `niter` total number of iterations. The default number of iterations is too small and need to be increased to reach convergence.

Only the model of index `x` will be used to run the model. 

The function returns:

* `model` a list including estimates of coefficients and model characteristics
* `tab` a data frame with information on model wAIC





```{r example-gro_run}
age <- rnorm(10000, 0, 1)
id1 =  rnorm(21,0, 0.5)
id2 =  rnorm(21,0, 0.4)
id3 =  rnorm(21,0, 0.3)
IND =sample(c(1:20), 100, replace = TRUE)
z <- 0.2+ id1[IND]+ (15 + id2[IND])* (1 - exp(-(1+ id3[IND]) * age)) +
  rnorm(100, 0, 0.01)
dat = data.frame(age = age, z = z, 
                 IND = as.numeric(factor(IND ,labels = c(1:length(unique(IND)))))
)

#Run a vonbertalanffy model including an individual effect on z0
out = Gro_run(1, 
              dat,
              all_mods  = c("vonbertalanffy"),
              random = c("z0"),
              run = list(nit = 500, nburnin = 100, nthin = 10, nch = 3))
out$tab

```

# Growth analysis: run multiple models

This function fits a series of growth models to a dataset, and select the best one by wAIC. It takes as arguments:

* data_weight including at least the numeric columns *Age*, *MeasurementValue* and *AnimalAnonID* 
* all_mods indicating the growth models that need to be fit.The following models are supported : logistic, gompertz, tpgm, power, richards, vonbertalanffy. default = "vonBertalanffy"
* `random` list of the model names giving the parameters that should include an individual random effect. See the example



```{r example-Gro_analysis}
Age <- sample(c(0:10), 1000, replace = TRUE)
MeasurementValue <- exp(0.2+15 * (1 - exp(-(0.1) * log(Age+1)))+ rnorm(1000,0,0.01))-1 
AnimalAnonID <- sample(c(0:20), 100, replace = TRUE)
dat = data.frame(Age = Age, MeasurementValue = MeasurementValue, 
                 AnimalAnonID = AnimalAnonID, MeasurementType = "Live Weight")

#Test 4 models: vonbertalanffy including an individual random effect on z0
#               vonbertalanffy including individual random effects on z0 and zinf
#               gompertz including an individual random effect on gamma 
#               gompertz including no individual random effect
a = Gro_analysis(dat, all_mods  = c("vonbertalanffy", "gompertz"),
                 random = list(vonbertalanffy = c("z0", "z0, zinf"), gompertz = c("gamma", "")),
                 run = list(nit = 1000, nburnin = 100, nthin = 1, nch = 1))
```

# Growth Model Setting

This function gets the parameter and equations for the growth model and takes as arguments:

* `data`, a data frame including at least the numeric columns *age*, *z* and *IND*
* `random`  name of the parameters that must include an individual random effect
* `mod` Name of the model to fit. The following models are supported : logistic, gompertz, tpgm, power, richards, vonbertalanffy.



```{r example-Gro_ModSettings}
age <- rnorm(100, 0, 1)
z <- 0.2+ 15 * (1 - exp(-(1) * age)) +rnorm(100, 0, 0.01)
dat = data.frame(age = age, z = z,IND =sample(c(0:20), 100, replace = TRUE)
)
model <- Gro_ModSettings(data = dat, mod = "vonbertalanffy")
```

# Plot model prediction

This function gives the predicted values of the model and plots to check the convergence of the model. It takes as arguments:

* `data` including at least the numeric columns *Age*, *MeasurementValue* and *AnimalAnonID* 
* `out` result output named `model` from Gro_run() or from Gro$analysis()

It returns the following object:

*`summary`shomwing mean, standard deviation, credible interval at 95% and the Gelman-Rubin statistics Rhat of each parameter.
* `predictions` giving the mean estimates and credible interval at 95% of each age
 `GOF`: 4 tests of goodness of fit: "normal": test if residuals are normally distributes ; "X"; test if there is a trend between residual and Age, "var": Test if there is the trend in the variance of the residuals over Age ,"conv": check if all Rhat < 1.1
* `plot_pred` Plot of the predicted values, credible interval at 95% in grey and data points.
* `convergence`: Plots of the Bayesian chains 
* `posterior`: Plots of the posterior distribution for each parameter


```{r example-Gro_pred}
Age <- sample(c(0:10), 100, replace = TRUE)
AnimalAnonID <- sample(c(0:20), 100, replace = TRUE)
MeasurementValue <- exp(0.2+15 * (1 - exp(-(0.1) * log(Age+1)))+ 
                          rnorm(100,0,0.01) + AnimalAnonID*0.1)-1 
dat = data.frame(Age = Age, MeasurementValue = MeasurementValue, 
                 AnimalAnonID = AnimalAnonID, MeasurementType = "Live Weight")

out = Gro_analysis(dat, 
                   all_mods = c("vonbertalanffy"),
                   run = list(nit = 1000, nburnin = 100, nthin = 1, nch = 3))

p <- Gro_pred(data = dat, 
              out = out$model, 
              title =out$wAIC_tab$model[1])
p$summary
p$predictions
p$GOF
p$plot_pred
p$convergence
p$posterior
```

